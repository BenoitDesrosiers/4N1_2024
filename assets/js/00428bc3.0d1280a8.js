"use strict";(self.webpackChunknotes_de_cours_4_n_1_2024=self.webpackChunknotes_de_cours_4_n_1_2024||[]).push([[4675],{9348:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>c,toc:()=>d});var i=s(5893),t=s(1151);const r={sidebar_position:135,draft:!1},a="Injection de d\xe9pendances",c={id:"WPF partie 1/injection_dependance",title:"Injection de d\xe9pendances",description:"Avant d'introduire la prochaine section, nous devons introduire l'injection de d\xe9pendances",source:"@site/docs/70-WPF partie 1/injection_dependance.md",sourceDirName:"70-WPF partie 1",slug:"/WPF partie 1/injection_dependance",permalink:"/4N1_2024/docs/WPF partie 1/injection_dependance",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:135,frontMatter:{sidebar_position:135,draft:!1},sidebar:"NotesSidebar",previous:{title:"SuperCarte.EF",permalink:"/4N1_2024/docs/WPF partie 1/supercarte_ef"},next:{title:"SuperCarte.Core",permalink:"/4N1_2024/docs/WPF partie 1/supercarte_core"}},l={},d=[{value:"D\xe9finition",id:"d\xe9finition",level:2},{value:"Qu&#39;est-ce qu&#39;une d\xe9pendance ?",id:"quest-ce-quune-d\xe9pendance-",level:2},{value:"Pourquoi opter pour l\u2019injection de d\xe9pendances ?",id:"pourquoi-opter-pour-linjection-de-d\xe9pendances-",level:2},{value:"Les abstractions",id:"les-abstractions",level:3},{value:"Les tests unitaires",id:"les-tests-unitaires",level:3},{value:"Th\xe9orie: interfaces",id:"th\xe9orie-interfaces",level:2},{value:"Comment sera utilis\xe9e l&#39;injection de d\xe9pendance dans ce projet",id:"comment-sera-utilis\xe9e-linjection-de-d\xe9pendance-dans-ce-projet",level:2},{value:"Type d&#39;enregistrement des d\xe9pendances",id:"type-denregistrement-des-d\xe9pendances",level:2}];function o(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"injection-de-d\xe9pendances",children:"Injection de d\xe9pendances"}),"\n",(0,i.jsx)(n.p,{children:"Avant d'introduire la prochaine section, nous devons introduire l'injection de d\xe9pendances"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/fr-fr/dotnet/architecture/modern-web-apps-azure/architectural-principles#dependency-inversion",children:"https://learn.microsoft.com/fr-fr/dotnet/architecture/modern-web-apps-azure/architectural-principles#dependency-inversion"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/fr-fr/dotnet/core/extensions/dependency-injection",children:"https://learn.microsoft.com/fr-fr/dotnet/core/extensions/dependency-injection"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://youtu.be/Hhpq7oYcpGE?si=uyluJ3V_JQtpRzX8",children:"https://youtu.be/Hhpq7oYcpGE?si=uyluJ3V_JQtpRzX8"})}),"\n",(0,i.jsx)(n.h2,{id:"d\xe9finition",children:"D\xe9finition"}),"\n",(0,i.jsxs)(n.p,{children:["L\u2019injection de d\xe9pendances consiste, pour une classe, \xe0 d\xe9l\xe9guer la cr\xe9ation de ses d\xe9pendances au code appelant qui va ensuite les injecter dans la classe correspondante. De ce fait, la cr\xe9ation d\u2019une instance de la d\xe9pendance est effectu\xe9e \xe0 l\u2019ext\xe9rieur de la classe d\xe9pendante et inject\xe9e dans la classe (le plus souvent dans le constructeur mais il existe d\u2019autres possibilit\xe9s). ",(0,i.jsx)(n.a,{href:"https://www.softfluent.fr/blog/injection-de-dependances-a-quoi-ca-sert/#:~:text=L'injection%20de%20d%C3%A9pendances%20consiste,injecter%20dans%20la%20classe%20correspondante.",children:"source"})]}),"\n",(0,i.jsx)(n.h2,{id:"quest-ce-quune-d\xe9pendance-",children:"Qu'est-ce qu'une d\xe9pendance ?"}),"\n",(0,i.jsxs)(n.p,{children:["Lorsqu'une fonction dans la classe A fait un new() d'un objet d'une clases B, la classe A devient ",(0,i.jsx)(n.em,{children:"d\xe9pendante"})," de la classe B. Si, par exemple, on veut utiliser la classe A dans un autre projet, on doit obligatoirement introduire la classe B dans ce projet aussi."]}),"\n",(0,i.jsx)(n.p,{children:"Une d\xe9pendance est donc toute classe externe utilis\xe9e pour cr\xe9er une instance \xe0 l'int\xe9rieur de la classe active."}),"\n",(0,i.jsx)(n.p,{children:"Le m\xe9canisme d'injection de d\xe9pendances permet de briser cette relation directe de A vers B. Au lieu d'avoir une relation directe, on aura une relation indirecte permettant d'utiliser n'importe quelle classe qui r\xe9pondra \xe0 la d\xe9finition (l'interface) de B. Il sera donc possible d'utiliser autre chose que B avec A."}),"\n",(0,i.jsx)(n.h2,{id:"pourquoi-opter-pour-linjection-de-d\xe9pendances-",children:"Pourquoi opter pour l\u2019injection de d\xe9pendances ?"}),"\n",(0,i.jsx)(n.p,{children:"Il y a deux raisons principales : l\u2019utilisation d\u2019abstractions et les tests unitaires."}),"\n",(0,i.jsx)(n.h3,{id:"les-abstractions",children:"Les abstractions"}),"\n",(0,i.jsx)(n.p,{children:"L\u2019abstraction est un des principes fondamentaux de la programmation orient\xe9e objet. En suivant ce processus d\u2019abstraction, le d\xe9veloppeur masque toutes les informations non pertinentes d\u2019un objet \xe0 des fins de simplification et d\u2019efficacit\xe9."}),"\n",(0,i.jsx)(n.p,{children:"Les abstractions sont g\xe9n\xe9ralement impl\xe9ment\xe9es en tant que classes ou interfaces abstraites et permettent d\u2019introduire la notion de contrat, dans la syntaxe C# ce sont les interfaces. Ce sont elles qui vont permettre la mise en \u0153uvre du principe d'injection de d\xe9pendances."}),"\n",(0,i.jsx)(n.p,{children:"Lorsque les modules de bas niveau impl\xe9mentent des interfaces et que ce sont ces interfaces qui sont inject\xe9es dans les modules de haut niveau, on ne d\xe9pend plus des impl\xe9mentations (des \xab d\xe9tails \xbb) et on peut d\xe8s lors \xab remplacer \xbb une impl\xe9mentation par une autre tant que la nouvelle impl\xe9mentation respecte l\u2019abstraction (c\u2019est-\xe0-dire qu\u2019elle impl\xe9mente l\u2019interface)."}),"\n",(0,i.jsx)(n.p,{children:"On voit que gr\xe2ce aux abstractions nous avons introduit un d\xe9couplage des modules (on peut aussi parler de \xab couplage faible \xbb) et que gr\xe2ce \xe0 cela la modification ou le remplacement d\u2019un module de bas niveau n\u2019a pas d\u2019impact sur les modules qui en d\xe9pendent (du moins tant que l\u2019abstraction, le contrat, ne change pas)."}),"\n",(0,i.jsx)(n.h3,{id:"les-tests-unitaires",children:"Les tests unitaires"}),"\n",(0,i.jsx)(n.p,{children:"Le deuxi\xe8me b\xe9n\xe9fice principal de l\u2019injection de d\xe9pendances r\xe9side dans la facilit\xe9 de r\xe9diger des tests unitaires."}),"\n",(0,i.jsx)(n.p,{children:"Les tests unitaires sont men\xe9s par le d\xe9veloppeur lui-m\xeame, et consistent \xe0 v\xe9rifier la bonne ex\xe9cution des fonctions dont il a la charge. Ces fonctions sont test\xe9es de mani\xe8re ind\xe9pendante, souvent avec des donn\xe9es r\xe9duites. Il est souhaitable de d\xe9finir tr\xe8s t\xf4t des jeux de tests repr\xe9sentatifs, car le d\xe9veloppeur pourra r\xe9aliser les tests unitaires sur cette base et la qualit\xe9 en sera am\xe9lior\xe9e."}),"\n",(0,i.jsx)(n.p,{children:"L\u2019objectif d\u2019un test unitaire est donc de tester une \xab unit\xe9 de code \xbb dans une situation donn\xe9e. Un test unitaire n\u2019a surtout pas pour vocation de tester toute une chaine d\u2019impl\xe9mentations et notamment les diff\xe9rentes impl\xe9mentations des d\xe9pendances de la classe test\xe9e."}),"\n",(0,i.jsx)(n.p,{children:"En l\u2019absence d\u2019un m\xe9canisme d\u2019injection de d\xe9pendances, une des principales difficult\xe9s pour \xe9crire des tests unitaires corrects va \xeatre de s\u2019affranchir des d\xe9pendances de la classe puisqu\u2019elle les instancie elle-m\xeame."}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://www.softfluent.fr/blog/injection-de-dependances-a-quoi-ca-sert/#:~:text=L'injection%20de%20d%C3%A9pendances%20consiste,injecter%20dans%20la%20classe%20correspondante.",children:"source"})}),"\n",(0,i.jsx)(n.h2,{id:"th\xe9orie-interfaces",children:"Th\xe9orie: interfaces"}),"\n",(0,i.jsxs)(n.p,{children:["Les interfaces sont utilis\xe9es afin de d\xe9connecter encore plus l'application des classes qui r\xe9aliseront les op\xe9rations demand\xe9es. Une interface d\xe9finie une suite d'op\xe9rations que devront implanter les classes qui respectent cette interface. De cette fa\xe7on, il est possible de remplacer une classe par une autre, tant qu'elle respecte l'interface. Une interface est, en quelque sorte, un contrat. Les classes indiquent qu'elles impl\xe9mentent toutes les fonctionnalit\xe9s d\xe9finies dans l'interface. Si une classe A utilisant une classe B respectant une interface C, alors A est assur\xe9e que toutes les fonctionnalit\xe9s de C sont implant\xe9es dans B. En quelques sortes, une interface d\xe9finie le ",(0,i.jsx)(n.strong,{children:"quoi"}),", alors que la classe qui l'impl\xe9mente va d\xe9finir le ",(0,i.jsx)(n.strong,{children:"comment"}),"."]}),"\n",(0,i.jsx)(n.admonition,{type:"tip",children:(0,i.jsxs)(n.p,{children:["Il est possible de g\xe9n\xe9rer automatiquement l'interface \xe0 partir d'une classe avec une action rapide dans Visual Studio. Placez le curseur sur le nom de la classe, faites ",(0,i.jsx)(n.strong,{children:"CTRL+."})," (CTRL et le point) et s\xe9lectionnez ",(0,i.jsx)(n.strong,{children:"Extraire l'interface"}),". (ou ",(0,i.jsx)(n.strong,{children:"CTRL+R, CTRL+I"}),", ou Edition/Refactoriser/Extraire interface)"]})}),"\n",(0,i.jsx)(n.admonition,{type:"info",children:(0,i.jsxs)(n.p,{children:["En ",(0,i.jsx)(n.strong,{children:"c#"}),", si un membre provient de l'interface, il faut seulement le documenter dans l'interface pour respecter le principe ",(0,i.jsx)(n.strong,{children:"DRY (Don't Repeate Yourself) ou Ne te r\xe9p\xe8te pas."})]})}),"\n",(0,i.jsx)(n.h2,{id:"comment-sera-utilis\xe9e-linjection-de-d\xe9pendance-dans-ce-projet",children:"Comment sera utilis\xe9e l'injection de d\xe9pendance dans ce projet"}),"\n",(0,i.jsx)(n.p,{children:"Il existe plusieurs fa\xe7ons d'int\xe9grer l'injection de d\xe9pendance"}),"\n",(0,i.jsxs)(n.p,{children:["Nous utiliserons un h\xf4te g\xe9n\xe9rique .NET (",(0,i.jsx)(n.a,{href:"https://learn.microsoft.com/fr-fr/dotnet/core/extensions/generic-host?tabs=hostbuilder",children:"pour plus d'info"}),")"]}),"\n",(0,i.jsxs)(n.p,{children:["Plus pr\xe9cis\xe9ment, nous utiliserons un ",(0,i.jsx)(n.strong,{children:"IHostBuilder"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["Voici un extrait de la section ",(0,i.jsx)(n.strong,{children:"Param\xe8tres du g\xe9n\xe9rateur d'h\xf4te"})," de cette page. Nous verrons plus en d\xe9tails les \xe9l\xe9ments en gras:"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["La m\xe9thode ",(0,i.jsx)(n.strong,{children:"CreateDefaultBuilder"})," :"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"D\xe9finit le chemin retourn\xe9 par GetCurrentDirectory() comme racine de contenu."}),"\n",(0,i.jsxs)(n.li,{children:["Charge la configuration de l\u2019h\xf4te \xe0 partir de :","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Variables d\u2019environnement comportant le pr\xe9fixe DOTNET_."}),"\n",(0,i.jsx)(n.li,{children:"Arguments de ligne de commande"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Charge la configuration de l\u2019application \xe0 partir de :","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"appsettings.json"})}),"\n",(0,i.jsx)(n.li,{children:"appsettings.{Environment}.json"}),"\n",(0,i.jsx)(n.li,{children:"Secret Manager quand l\u2019application s\u2019ex\xe9cute dans l\u2019environnement Development."}),"\n",(0,i.jsx)(n.li,{children:"Variables d'environnement."}),"\n",(0,i.jsx)(n.li,{children:"Arguments de ligne de commande"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Ajoute les fournisseurs de journalisation suivants :","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Console"}),"\n",(0,i.jsx)(n.li,{children:"D\xe9boguer"}),"\n",(0,i.jsx)(n.li,{children:"EventSource"}),"\n",(0,i.jsx)(n.li,{children:"EventLog (uniquement en cas d\u2019ex\xe9cution sur Windows)"}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:"Active la validation de l\u2019\xe9tendue et la validation de d\xe9pendances lorsque l\u2019environnement est Development."}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Utilisez la m\xe9thode ",(0,i.jsx)(n.strong,{children:"ConfigureServices"})," pour ajouter des services \xe0 l\u2019instance ",(0,i.jsx)(n.strong,{children:"Microsoft.Extensions.DependencyInjection.IServiceCollection"}),". Ces services permettent de cr\xe9er un ",(0,i.jsx)(n.strong,{children:"IServiceProvider"})," utilis\xe9 avec l\u2019injection de d\xe9pendances pour r\xe9soudre les services inscrits."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:["Afin de faire l'injection, nous allons enregistrer une interfaces (",(0,i.jsx)(n.strong,{children:"I"}),") et lui associer une classe (",(0,i.jsx)(n.strong,{children:"C"}),") \xe0 injecter. Dans le code, si une fonction requiert un objet du type ",(0,i.jsx)(n.strong,{children:"I"}),", alors un objet de la classe ",(0,i.jsx)(n.strong,{children:"C"})," sera fourni. Le new est fait par le syst\xe8me d'injection, il n'est donc pas visible dans le code de l'application."]}),"\n",(0,i.jsx)(n.p,{children:"Par exemple, nous allons enregistrer des Services via leur interface:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-csharp",metastring:'title="Ne pas copier"',children:"services.AddScoped<ICategorieService, CategorieService>();\n"})}),"\n",(0,i.jsx)(n.p,{children:"Plus tard, nous d\xe9finirons une classe pour g\xe9rer les cat\xe9gories. Le constructeur de cette classe indiquera qu'il a besoin de qqchose qui r\xe9pond \xe0 l'interface ICategorieService"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-csharp",metastring:'title="Ne pas copier"',children:"public GestionCategorieVM(ICategorieService categorieService)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Le syst\xe8me va g\xe9n\xe9rer une nouvelle instance (si n\xe9cessaire) de la classe qui est pr\xe9sentement associ\xe9e \xe0 ",(0,i.jsx)(n.strong,{children:"ICategorieService"}),", c'est \xe0 dire: ",(0,i.jsx)(n.strong,{children:"CategorieService"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Il est donc tr\xe8s facile de changer la classe associ\xe9e \xe0 ICategorieService. Il suffit de changer la ligne d'association, et tout le code utilisera maintenant une nouvelle classe. (nous verrons que cette technique est utilis\xe9e pour faire des tests unitaires)"}),"\n",(0,i.jsx)(n.p,{children:"Dans la section suivante, nous allons mettre en place plusieurs interfaces/classes qui seront par la suite utilis\xe9es dans la section WPF. L'injection de d\xe9pendances ne sera donc pas directement utilis\xe9e dans la partie Core. Elle sera r\xe9ellement utilis\xe9e dans la partie WPF du projet. Mais il faut mettre les choses en place."}),"\n",(0,i.jsx)(n.h2,{id:"type-denregistrement-des-d\xe9pendances",children:"Type d'enregistrement des d\xe9pendances"}),"\n",(0,i.jsx)(n.p,{children:"Il existe 3 types d'enregistrement pour les d\xe9pendances. Ces types d'enregistrement consistent \xe0 la dur\xe9e de vie de l'instance de la classe qui sera cr\xe9\xe9e lors de l'injection."}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Transient"})}),"\n",(0,i.jsx)(n.p,{children:"Une nouvelle instance est cr\xe9\xe9e \xe0 chaque fois qu'un objet demande une injection de cette d\xe9pendance."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Scoped"})}),"\n",(0,i.jsxs)(n.p,{children:["Une seule instance est cr\xe9\xe9e pour toute la dur\xe9e de vie du ",(0,i.jsx)(n.strong,{children:"scope"}),". Tous les objets qui demandent une injection de ce service \xe0 l'int\xe9rieur du ",(0,i.jsx)(n.strong,{children:"scope"})," auront la m\xeame instance."]}),"\n",(0,i.jsxs)(n.p,{children:["En application console, le ",(0,i.jsx)(n.strong,{children:"scope"})," doit \xeatre cr\xe9\xe9 manuellement."]}),"\n",(0,i.jsxs)(n.p,{children:["Par contre, dans le cas d'une application ",(0,i.jsx)(n.strong,{children:"Blazor Server"}),", un rafraichissement du navigateur ou un nouvel onglet consiste \xe0 un nouveau ",(0,i.jsx)(n.strong,{children:"scope"}),". Le changement de page sans rafraichissement du navigateur n'occasionne pas de changement de ",(0,i.jsx)(n.strong,{children:"scope"}),". Le ",(0,i.jsx)(n.strong,{children:"scope"})," consiste \xe0 la cr\xe9ation de la requ\xeate initiale avec le serveur par le navigateur."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Singleton"})}),"\n",(0,i.jsx)(n.p,{children:"Une seule instance est cr\xe9\xe9e pour toute la dur\xe9e de vie de l'application."}),"\n"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},1151:(e,n,s)=>{s.d(n,{Z:()=>c,a:()=>a});var i=s(7294);const t={},r=i.createContext(t);function a(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);